---
import BaseLayout from '../../layouts/BaseLayout.astro';
---
<BaseLayout title="Create New Post">
    <div class="container">
        <h1>Create New Post</h1>
        <form id="postForm" method="POST" action="/api/posts">
            <input type="hidden" id="actionType" name="actionType" value="publish">

            <label for="title">Title</label>
            <input type="text" id="title" name="title" required>

            <label for="slug">Slug</label>
            <input type="text" id="slug" name="slug" required>

            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3" required></textarea>

            <label for="tableOfContents">Table of Contents (optional)</label>
            <textarea id="tableOfContents" name="tableOfContents" rows="4"></textarea>

            <label for="focusKeyword">Focus Keyword</label>
            <input type="text" id="focusKeyword" name="focusKeyword" placeholder="e.g., 'Astro.js tips'">

            <label for="author">Author</label>
            <input type="text" id="author" name="author" required>

            <label for="pubDate">Publication Date</label>
            <input type="date" id="pubDate" name="pubDate" required>

            <label for="heroImage">Hero Image URL</label>
            <input type="text" id="heroImage" name="heroImage">

            <label for="content">Content (Markdown)</label>
            <textarea id="content" name="content" rows="15" required></textarea>

            <div id="analysisResult" class="analysis-box"></div>

            <div id="scheduleContainer" style="display: none;">
                <label for="scheduleDate">Schedule for:</label>
                <input type="datetime-local" id="scheduleDate" name="scheduleDate">
            </div>

            <div class="button-group">
                <button type="button" id="analyzeBtn" class="secondary">Analyze Post</button>
                <button type="button" id="draftBtn" class="secondary">Save as Draft</button>
                <button type="button" id="scheduleBtn" class="secondary">Schedule Post</button>
                <button type="submit" id="publishBtn" class="primary">Publish</button>
            </div>
        </form>
    </div>
</BaseLayout>

<script>
    const form = document.getElementById('postForm');
    const actionTypeInput = document.getElementById('actionType');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const draftBtn = document.getElementById('draftBtn');
    const scheduleBtn = document.getElementById('scheduleBtn');
    const scheduleContainer = document.getElementById('scheduleContainer');
    const analysisResult = document.getElementById('analysisResult');

    // --- Action Buttons --- //
    draftBtn.addEventListener('click', () => {
        actionTypeInput.value = 'draft';
        form.submit();
    });

    scheduleBtn.addEventListener('click', () => {
        if (scheduleContainer.style.display === 'none') {
            scheduleContainer.style.display = 'block';
            scheduleBtn.textContent = 'Submit for Scheduling';
        } else {
            actionTypeInput.value = 'schedule';
            form.submit();
        }
    });

    // --- Analysis Button --- //
    analyzeBtn.addEventListener('click', () => {
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const content = document.getElementById('content').value;
        const focusKeyword = document.getElementById('focusKeyword').value.toLowerCase();
        
        let score = 0;
        const suggestions = [];
        const goodPoints = [];

        const wordCount = content.trim().split(/\s+/).filter(Boolean).length;

        // 1. Focus Keyword Checks (45 points)
        if (!focusKeyword) {
            suggestions.push('Set a focus keyword to get SEO suggestions.');
        } else {
            if (title.toLowerCase().includes(focusKeyword)) { score += 15; goodPoints.push('Focus keyword is in the title.'); } 
            else { suggestions.push('Add your focus keyword to the SEO title.'); }

            if (description.toLowerCase().includes(focusKeyword)) { score += 15; goodPoints.push('Focus keyword is in the description.'); } 
            else { suggestions.push('Add your focus keyword to the meta description.'); }

            const keywordCount = (content.toLowerCase().match(new RegExp(focusKeyword, 'g')) || []).length;
            const density = (keywordCount / wordCount) * 100;
            if (density >= 1 && density <= 2) { score += 15; goodPoints.push(`Keyword density is great (${density.toFixed(1)}%).`); } 
            else if (density < 1) { suggestions.push(`Keyword density is low (${density.toFixed(1)}%). Use the focus keyword more in your content.`); } 
            else { suggestions.push(`Keyword density is high (${density.toFixed(1)}%). Avoid keyword stuffing.`); }
        }

        // 2. Title Length (15 points)
        if (title.length >= 50 && title.length <= 60) { score += 15; goodPoints.push('Title length is optimal (50-60 chars).'); } 
        else { suggestions.push(`Title is ${title.length} chars. Aim for 50-60 characters.`); }

        // 3. Description Length (15 points)
        if (description.length >= 150 && description.length <= 160) { score += 15; goodPoints.push('Description length is optimal (150-160 chars).'); } 
        else { suggestions.push(`Meta description is ${description.length} chars. Aim for 150-160 characters.`); }

        // 4. Content Length (15 points)
        if (wordCount >= 300) { score += 15; goodPoints.push(`Content length is good (${wordCount} words).`); } 
        else { suggestions.push(`Content is too short (${wordCount} words). Aim for at least 300 words.`); }

        // 5. Subheadings (10 points)
        const subheadingCount = (content.match(/^##\s/gm) || []).length;
        if (subheadingCount > 0) { score += 10; goodPoints.push(`You are using ${subheadingCount} subheadings (H2s).`); } 
        else { suggestions.push('Use subheadings (starting with ##) to break up your content.'); }

        // Display Results
        let html = `<p><strong>SEO Score: ${score} / 100</strong></p>`;
        if (suggestions.length > 0) {
            html += '<h5>Suggestions for Improvement:</h5><ul>';
            suggestions.forEach(s => { html += `<li>${s}</li>`; });
            html += '</ul>';
        }
        if (goodPoints.length > 0) {
             html += '<h5>Good Points:</h5><ul>';
            goodPoints.forEach(p => { html += `<li>${p}</li>`; });
            html += '</ul>';
        }

        analysisResult.innerHTML = html;
        analysisResult.style.display = 'block';
    });
</script>

<style>
    .container { max-width: 800px; margin: 2rem auto; padding: 2rem; border: 1px solid #ddd; border-radius: 8px; }
    form { display: flex; flex-direction: column; }
    label { margin-top: 1rem; font-weight: 600; }
    input, textarea { padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    .button-group { display: flex; justify-content: flex-end; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; }
    button { padding: 0.8rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600; }
    button.primary { background-color: #007bff; color: white; }
    button.primary:hover { background-color: #0056b3; }
    button.secondary { background-color: #6c757d; color: white; }
    button.secondary:hover { background-color: #5a6268; }
    .analysis-box { display: none; margin-top: 1.5rem; padding: 1.5rem; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; }
    .analysis-box h5 { margin-top: 0; margin-bottom: 0.5rem; }
    .analysis-box ul { margin: 0; padding-left: 20px; }
    #scheduleContainer { margin-top: 1rem; }
</style>
