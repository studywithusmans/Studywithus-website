---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { SITE_TITLE } from "../../consts";

const posts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<BaseLayout title={`Admin Dashboard - ${SITE_TITLE}`}>
  <div class="admin-container">
    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <a href="/api/auth/logout" class="logout-button">Logout</a>
    </div>
    <a href="/admin/new" class="add-new-button">+ Add New Post</a>
    <ul class="post-list">
      {posts.map((post) => {
        const wordCount = post.body.split(" ").length;
        const descriptionLength = post.data.description.length;

        const seoIssues = [];
        if (wordCount < 500) {
          seoIssues.push(`Post is short (${wordCount} words). Aim for 500+.`);
        }
        if (!post.data.heroImage) {
          seoIssues.push("Hero image is missing.");
        }
        if (!post.data.imageAlt && post.data.heroImage) {
          seoIssues.push("Hero image is missing alt text.");
        }
         if (descriptionLength < 70 || descriptionLength > 160) {
          seoIssues.push(`Description length is suboptimal (aim for 70-160 chars).`);
        }


        return (
          <li class="post-item">
            <div class="post-date">{post.data.pubDate.toLocaleDateString()}</div>
            <h2 class="post-title">{post.data.title}</h2>
            <p class="post-description">{post.data.description}</p>
            <div class="seo-score">
              <strong>SEO Score: {100 - (seoIssues.length * 15)}</strong>
              <ul>
                {seoIssues.map(issue => <li>{issue}</li>)}
              </ul>
            </div>
            <div class="post-actions">
              <a href={`/admin/edit-post/${post.slug}/`} class="edit-link">Edit</a>
              <a href={`/admin/delete-post/${post.slug}/`} class="delete-link">Delete</a>
            </div>
          </li>
        );
      })}
    </ul>
  </div>
</BaseLayout>

<style>
  .admin-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
    background-color: #fff;
    border-radius: 8px;
  }
  .admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .admin-header h1 {
    font-size: 2rem;
    color: #1a202c;
  }

  .logout-button {
    display: inline-block;
    padding: 0.5rem 1rem;
    background-color: #e53e3e;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: bold;
    transition: background-color 0.3s;
  }

  .logout-button:hover {
    background-color: #c53030;
  }

  .add-new-button {
    display: inline-block;
    margin-bottom: 2rem;
    padding: 0.75rem 1.5rem;
    background-color: #3182ce;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: bold;
    transition: background-color 0.3s;
  }

  .add-new-button:hover {
    background-color: #2b6cb0;
  }

  .post-list {
    list-style: none;
    padding: 0;
  }

  .post-item {
    border: 1px solid #e2e8f0;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .post-date {
    font-size: 0.875rem;
    color: #718096;
    margin-bottom: 0.5rem;
  }

  .post-title {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    color: #2d3748;
  }

  .post-description {
    color: #4a5568;
    margin-bottom: 1rem;
  }

  .seo-score {
    margin-bottom: 1rem;
    padding: 1rem;
    background-color: #f7fafc;
    border-radius: 4px;
  }

  .seo-score strong {
      display: block;
      margin-bottom: 0.5rem;
  }

  .seo-score ul {
      padding-left: 20px;
      margin: 0;
  }

  .post-actions a {
    color: #3182ce;
    text-decoration: none;
    margin-right: 1rem;
    font-weight: 500;
  }

  .post-actions a:hover {
    text-decoration: underline;
  }

  .delete-link {
      color: #e53e3e;
  }
</style>
